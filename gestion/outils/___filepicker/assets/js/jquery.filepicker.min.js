+function(t,e){"use strict";function i(e){var i="dragover"===e;return function(o){o.dataTransfer=o.originalEvent&&o.originalEvent.dataTransfer;var n=o.dataTransfer;n&&-1!==t.inArray("Files",n.types)&&this.trigger(e,t.Event(e,{delegatedEvent:o}))!==!1&&(o.preventDefault(),i&&(n.dropEffect="copy"))}}function o(e){return e?this.each(function(){var i=t(this);i.data("filepicker")||i.data("filepicker",new r(this,e))}):t(this).data("filepicker")}function n(t,e){var i=/[^A-Za-z0-9_-]/.test(t)?new Function("obj","var p=[],print=function(){p.push.apply(p,arguments);};with(obj){p.push('"+t.replace(/[\r\t\n]/g," ").replace(/'(?=[^%]*%>)/g,"	").split("'").join("\\'").split("	").join("'").replace(/<%=(.+?)%>/g,"',$1,'").split("<%").join("');").split("%>").join("p.push('")+"');}return p.join('');"):s[t]=s[t]||n(document.getElementById(t).innerHTML);return e?i(e):i}var r=function(e,i){this.element=t(e),this.options=t.extend({},r.defaults,i),this.initOptions(),this.initEventHandlers()};r.defaults={debug:!1,url:e,autoUpload:!0,autoLoad:!1,prependFiles:!0,acceptFileTypes:e,imageFileTypes:/(\.|\/)(gif|jpe?g|png)$/i,minFileSize:1,maxFileSize:e,maxNumberOfFiles:e,formData:[],paramName:"files",previewThumbnailSize:[64,64],messages:{acceptFileTypes:"The file type is not allowed.",maxFileSize:"The file exceeds the maximum allowed file size.",minFileSize:"The file size is too small.",maxNumberOfFiles:"Maximum number of files exceeded.",error:"Oops! Something went wrong.",browser:"Please upgrade your browser!"},fileInput:e,startBtn:e,cancelBtn:e,deleteBtn:e,filesList:e,dropZone:t(document),dropWindow:e,uploadTemplateId:"templateUpload",downloadTemplateId:"templateDownload",selectors:{cancel:".cancel",start:".start",destroy:".delete",preview:".preview",error:".error",progressbar:".progress-bar"}},r.prototype.initOptions=function(){var t=this.options;t.fileInput||(t.fileInput=this.element.is('input[type="file"]')?this.element:this.element.find('input[type="file"]')),t.filesList||(t.filesList=this.element.find(".files"),t.filesList.length||(t.filesList=e)),t.startBtn||(t.startBtn=this.element.find(".start")),t.cancelBtn||(t.cancelBtn=this.element.find(".cancel")),t.deleteBtn||(t.deleteBtn=this.element.find(".delete")),t.dropWindow||(t.dropWindow=this.element.find(".drop-window"))},r.prototype.initEventHandlers=function(){var t=this.options;this.on(t.fileInput,"change",this.onChange),this.on(t.dropZone,"dragover",this.onDragOver),this.on(t.dropZone,"dragenter",this.onDragEnter),this.on(t.dropZone,"dragleave",this.onDragLeave),this.on(t.dropZone,"drop",this.onDrop),this.on(t.filesList,"click",t.selectors.start,this.onStart),this.on(t.filesList,"click",t.selectors.cancel,this.onCancel),this.on(t.filesList,"click",t.selectors.destroy,this.onDestroy),this.on(t.startBtn,"click",this.onStartAll),this.on(t.cancelBtn,"click",this.onCancelAll),this.on(t.deleteBtn,"click",this.onDestroyAll),t.autoLoad&&this.autoLoad()},r.prototype.autoLoad=function(e,i){var o=this,n=this.formData().add({limit:e,offset:i});t.get(this.options.url,n,function(t){o.trigger("load",null,t)},"json")},r.prototype.load=function(e,i){if(!e.isDefaultPrevented()){var o=this;t.each(i.files,function(t,e){o.render(e)})}},r.prototype.onChange=function(e){if(!(window.File&&window.FileList&&window.FormData))return alert(this.trans("browser"));var i=this.getInputFiles(t(e.target));this.replaceFileInput(t(e.target)),this.onAdd(e,i)},r.prototype.onStart=function(e){e.preventDefault();var i=t(e.currentTarget),o=i.closest(".template-upload"),n=o.data("file");i.prop("disabled",!0),n&&n.send&&this.trigger("start",e,n)},r.prototype.onStartAll=function(t){t.preventDefault(),this.trigger("startall",t)},r.prototype.onCancel=function(e){e.preventDefault();var i=t(e.currentTarget).closest(".template-upload,.template-download"),o=i.data("file")||{};o.context=o.context||i,o.abort?o.abort():(o.errorThrown="abort",this.trigger("fail",e,o))},r.prototype.onCancelAll=function(t){t.preventDefault(),this.options.filesList.find(this.options.selectors.cancel).click()},r.prototype.onDestroy=function(e){e.preventDefault();var i=t(e.currentTarget).closest(".template-download");this.trigger("destroy",e,t.extend({context:i},i.data("file")))},r.prototype.onDestroyAll=function(t){t.preventDefault(),this.trigger("destroyall",t)},r.prototype.onDragOver=i("dragover"),r.prototype.onDragEnter=i("dragenter"),r.prototype.onDragLeave=i("dragleave"),r.prototype.onDrop=function(e){e.dataTransfer=e.originalEvent&&e.originalEvent.dataTransfer;var i=e.dataTransfer,o={};i&&i.files&&i.files.length&&(e.preventDefault(),o=t.makeArray(i.files),this.trigger("drop",t.Event("drop",{delegatedEvent:e,files:o}),o)!==!1&&this.onAdd(e,o))},r.prototype.onAdd=function(e,i){var o=this;t.each(i,function(i,n){n.sizeFormatted=o.formatFilesize(n.size),n.extension=o.getFileExtension(n.name),n.imageFileType=o.options.imageFileTypes.test(n.name),o.validate(n),o.addMethods(e,n),o.trigger("add",t.Event("add",{delegatedEvent:e}),n)})},r.prototype.onSend=function(e,i){return this.trigger("send",t.Event("send",{delegatedEvent:e}),i)===!1?this.onFail(0,i.errorThrown||"abort",i):void this.upload(i)},r.prototype.onProgress=function(e,i){i.progress={loaded:e.loaded,total:e.total},this.trigger("progress",t.Event("progress",{delegatedEvent:e}),i)},r.prototype.onSuccess=function(e,i){e&&e.files.length&&(i=t.extend({original:i},e.files[0]),this.extraProps(i),this.trigger("success",null,i))},r.prototype.onFail=function(t,e,i){i.status=t,i.errorThrown=e,this.trigger("fail",null,i)},r.prototype.onAlways=function(t,e){e.xhr=t,this.trigger("always",null,e)},r.prototype.add=function(t,e){return t.isDefaultPrevented()?!1:(this.options.filesList&&(e.context=this.renderTemplate(e,this.options.uploadTemplateId).data("file",e),this.renderThumbnailPreview(e),this.options.filesList[this.options.prependFiles?"prepend":"append"](e.context),this.transition(e.context)),void(!this.options.autoUpload&&!e.autoUpload||e.error||e.send()))},r.prototype.drop=function(t){t.isDefaultPrevented()||this.transition(this.options.dropWindow.hide())},r.prototype.dragover=function(t){t.isDefaultPrevented()||this.options.dropWindow.show().addClass("in")},r.prototype.dragleave=function(t){t.isDefaultPrevented()||this.options.dropWindow.hide().removeClass("in")},r.prototype.start=function(t,e){t.isDefaultPrevented()?e.context&&e.context.find(this.options.selectors.start).prop("disabled",!1):e.send()},r.prototype.startall=function(t){!t.isDefaultPrevented()&&this.options.filesList&&this.options.filesList.find(this.options.selectors.start).click()},r.prototype.progress=function(t,e){if(t.isDefaultPrevented()||!e.context)return!1;var i=Math.floor(e.progress.loaded/e.progress.total*100);e.context.find(this.options.selectors.progressbar).text(i+"%").css("width",i+"%")},r.prototype.success=function(t,e){t.isDefaultPrevented()||this.render(e)},r.prototype.fail=function(t,e){return t.isDefaultPrevented()?!1:void("abort"===e.errorThrown?this.transition(e.context,function(t){t.remove()}):(e.context.find(this.options.selectors.error).text(this.trans(e.errorThrown)),e.context.find(this.options.selectors.start).prop("disabled",!1),e._state=!1))},r.prototype.destroy=function(e,i){if(e.isDefaultPrevented())return!1;var o=this,n=this.formData().method("DELETE").add(this.getSingularParamName(),i.name);t.ajax({url:this.options.url,type:"POST",dataType:"json",data:n}).done(function(){o.trigger("destroyed",e,i)}).fail(function(){o.trigger("destroyfailed",e,i)})},r.prototype.destroyall=function(t){t.isDefaultPrevented()||this.options.filesList.find(this.options.selectors.destroy).click()},r.prototype.destroyed=function(t,e){this.transition(e.context,function(t){t.remove()})},r.prototype.upload=function(e){var i=this,o=e.xhr=t.ajaxSettings.xhr();o.open("POST",this.options.url,!0),o.upload.onprogress=function(o){o.lengthComputable&&i.onProgress(t.Event("progress",{loaded:o.loaded,total:o.total}),e)},o.onload=function(){if(200==o.status||201==o.status)try{i.onSuccess(t.parseJSON(o.responseText),e)}catch(n){}else i.log(o.responseText),i.onFail(o.status,i.trans("error"),e);i.onAlways(o,e)};var n=new FormData;t.each(e.formData,function(t,e){n.append(e.name,e.value)}),n.append(this.options.paramName,e,e.name),o.send(n)},r.prototype.addMethods=function(t,e){var i=this;e.abort=function(){this.xhr&&this.xhr.abort(),i.onFail(0,"abort",this)},e.send=function(){return"sending"===this.state()?!1:(this._state="sending",void(this.error||i.onSend(t,this)))},e.state=function(){return this._state?this._state:!1},e.formData=this.formData().method("POST")},r.prototype.validate=function(t){var i=this.options;return i.acceptFileTypes&&!i.acceptFileTypes.test(t.name)?t.error=this.trans("acceptFileTypes"):t.size!==e&&i.maxFileSize&&t.size>i.maxFileSize?t.error=this.trans("maxFileSize"):t.size!==e&&i.minFileSize&&t.size<i.minFileSize?t.error=this.trans("minFileSize"):i.maxNumberOfFiles&&this.getNumberOfFiles()>=i.maxNumberOfFiles&&(t.error=this.trans("maxNumberOfFiles")),t.error===e},r.prototype.renderTemplate=function(i,o){if(typeof n===e)throw new Error("Filepicker requires tmpl.js");return t(n(o,{file:i,options:this.options}))},r.prototype.render=function(t){this.extraProps(t);var e=this.renderTemplate(t,this.options.downloadTemplateId);if(t.context=e,e.data("file",t),t.original){var i=this;this.transition(t.original.context,function(t){t.replaceWith(e),i.transition(e)})}else this.options.filesList.append(e),this.transition(e)},r.prototype.renderThumbnailPreview=function(t){if(t.imageFileType){var e=this,i=document.createElement("canvas"),o=i.getContext("2d"),n=new Image;i.width=this.options.previewThumbnailSize[0],i.height=this.options.previewThumbnailSize[1],n.onload=function(){o.drawImage(n,0,0,80,80*n.height/n.width),t.context.find(e.options.selectors.preview).html(i)},n.src=URL.createObjectURL(t)}},r.prototype.extraProps=function(t){t.sizeFormatted||(t.sizeFormatted=this.formatFilesize(t.size),t.timeFormatted=t.time?this.formatFiletime(t.time):"",t.imageFileType=this.options.imageFileTypes.test(t.name))},r.prototype.formData=function(){var i=this.options.formData;if("function"!=typeof i&&(i=t.extend({},i)),"function"==typeof i&&(i=i()),"object"==typeof i){var o=[];for(var n in i)o.push({name:n,value:i[n]});i=o}return i===e&&(i=[]),i.add=function(t,e){if("object"==typeof t)for(var i in t)this.add(i,t[i]);else this.push({name:t,value:e});return this},i.method=function(t){return this.add("_method",t),this},i},r.prototype.addFormData=function(t,e,i){return t.push({name:e,value:i}),this},r.prototype.setMethod=function(t,e){this.addFormData(t,"_method",e)},r.prototype.replaceFileInput=function(e){var i=e.clone(!0);t("<form></form>").append(i)[0].reset(),e.after(i).detach(),t.cleanData(e.off("remove")),this.options.fileInput=this.options.fileInput.map(function(t,o){return o===e[0]?i[0]:o}),e[0]===this.element[0]&&(this.element=i)},r.prototype.getInputFiles=function(i){var o=t.makeArray(i.prop("files"));if(o.length)o[0].name===e&&o[0].fileName&&t.each(o,function(t,e){e.name=e.fileName,e.size=e.fileSize});else{var n=i.prop("value");if(!n)return[];o=[{name:n.replace(/^.*\\/,"")}]}return o},r.prototype.trans=function(t,e){return this.options.messages[t]||e||t.toString()},r.prototype.getNumberOfFiles=function(){return this.options.filesList.children().length},r.prototype.getSingularParamName=function(){return this.options.paramName.substr(0,this.options.paramName.length-1)},r.prototype.getFileExtension=function(t){return t.substr(t.lastIndexOf(".")+1,t.length)},r.prototype.formatFilesize=function(t){if("number"!=typeof t)return"";if(this.options.formatFilesize)return this.options.formatFilesize(t);var e={GB:1073741824,MB:1048576,KB:1024,B:1};for(var i in e)if(t>=e[i])return Math.round(t/e[i]*10)/10+" "+i},r.prototype.formatFiletime=function(t){if(this.options.formatFiletime)return this.options.formatFiletime(t);var e,i=new Date(1e3*t),o=i.getFullYear(),n=("0"+(i.getMonth()+1)).slice(-2),r=("0"+i.getDate()).slice(-2),s=i.getHours(),a=s,l=("0"+i.getMinutes()).slice(-2),p="AM";return s>12?(a=s-12,p="PM"):12===s?(a=12,p="PM"):0==s&&(a=12),e=o+"-"+n+"-"+r+", "+a+":"+l+" "+p},r.prototype.transition=function(t,e){t.toggleClass("in"),e&&window.setTimeout(function(){e(t)},150)},r.prototype.on=function(e,i,o,n){!e||!e instanceof t||(n||(n=o,o=null),e.on(i,o,t.proxy(n,this)))},r.prototype.trigger=function(e,i,o){var n,r,s=this.options[e]||this[e];if(o=o||{},i=t.Event(i),i.type=("filepicker."+e).toLowerCase(),i.target=this.element[0],r=i.originalEvent)for(n in r)n in i||(i[n]=r[n]);return this.element.trigger(i,o),!(t.isFunction(s)&&s.apply(this,[i].concat(o))===!1||i.isDefaultPrevented())},r.prototype.log=function(t){this.options.debug&&(alert(t),console.log(t))},t.fn.filePicker=o;var s={}}(jQuery);