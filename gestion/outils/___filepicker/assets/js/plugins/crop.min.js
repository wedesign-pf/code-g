+function(t,i){var o=function(i,e){this.filePicker=i,this.container=e.container,this.options=t.extend({},o.defaults,e),this.init()};o.defaults={aspectRatio:0,minSize:[0,0],maxSize:[0,0],setSelect:i,modal:!1},o.prototype.init=function(){return this.options.modal=this.container.hasClass("modal"),t.Jcrop?(this.options.preview||(this.options.preview=this.container.find(".crop-preview")),this.options.saveBtn||(this.options.saveBtn=this.container.find(".save")),this.options.cancelBtn||(this.options.cancelBtn=this.container.find(".cancel")),this.options.cropBtn?this.options.cropBtn.on("click",t.proxy(this.open,this)):this.filePicker.options.filesList.on("click",".crop",t.proxy(this.open,this)),this.options.saveBtn.on("click",t.proxy(this.save,this)).prop("disabled",!0),this.options.cancelBtn.on("click",t.proxy(this.close,this)),void(this.options.modal&&this.container.on("shown.bs.modal",t.proxy(this.show,this)).on("hidden.bs.modal",t.proxy(this.close,this)))):alert("Jcrop not loaded.")},o.prototype.open=function(t){this.options.modal?this.container.modal("show",t):(this.container.show(),this.show(t))},o.prototype.show=function(i){var o,e=t((i.relatedTarget?i.relatedTarget.currentTarget:!1)||i.currentTarget);if(o=e.data("file")?e.data("file"):e.closest(".template-download").data("file"),!o)return alert('Cannot read .data("file").');var n=this,s=function(t){t=t||{},n.coords={x:t.x,y:t.y,file:o.name,width:t.w,height:t.h}},r={onChange:s,onRelease:s,bgColor:"white",aspectRatio:this.options.aspectRatio,setSelect:this.options.setSelect,minSize:this.options.minSize,maxSize:this.options.maxSize,trueSize:[o.width,o.height]};s(),this.file=o;var a=new Image;a.onload=function(){o.url+=(o.url.indexOf("?")>-1?"&":"?")+(new Date).getTime();var i=t('<img src="'+o.url+'" style="visibility:hidden;">');n.options.preview.html(i).show(),i.Jcrop(r),n.options.saveBtn.prop("disabled",!1)},a.onerror=function(){alert("Image load error.")},a.src=o.url},o.prototype.close=function(){this.options.modal?this.container.modal("hide"):this.container.hide(),this.options.preview.html("")},o.prototype.save=function(){this.toggleBtn(),t.ajax({url:this.filePicker.options.url,type:"POST",dataType:"json",data:this.filePicker.formData().method("PUT").add(this.coords)}).done(t.proxy(this.saveComplete,this)).fail(function(){alert("Save error.")}).always(t.proxy(this.toggleBtn,this))},o.prototype.saveComplete=function(i){var o=i.file;o.versions.thumb&&(o.versions.thumb.url+=(o.versions.thumb.url.indexOf("?")>-1?"&":"?")+(new Date).getTime()),this.filePicker.options.filesList&&this.filePicker.render(t.extend({original:this.file},o)),this.filePicker.trigger("cropsuccess",null,o),this.close()},o.prototype.toggleBtn=function(){var i=this.options.saveBtn;t.fn.button?i.button(i.button().data("bs.button").isLoading?"reset":"loading"):i.prop("disabled",!i.prop("disabled"))},window.FilepickerCrop=function(i,e){return i instanceof t&&(i=i.filePicker()),new o(i,e)}}(jQuery);